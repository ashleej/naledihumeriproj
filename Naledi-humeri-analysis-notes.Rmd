---
title: "Notes on H. Naledi Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## MeshLab worklflow

1. Open model
2. Click ‘pick points’ button
3. Right-click to add points, click ‘not editing’ button to rotate and move model
4. In the pick points ‘form’ window, click Save to save points into a pp file (XML)

## Getting data from Google Drive

Our data are stored on Google Drive. We can access it for analysis using R

```{r}
library(googlesheets)
```


## Importing Meshlab data into R

```{r}
# https://rgriff23.github.io/2017/05/07/read-meshlab-pickedpoints.html
# function to read Meshlab *.pp files into R
read.pp <- function (file) {
	file <- readLines(file)
	lines <- file[grep("point", file)]
	x <- strsplit(lines, "x=\"")
	y <- strsplit(lines, "y=\"")
	z <- strsplit(lines, "z=\"")
	name <- strsplit(lines, "name=\"")
	mat <- matrix(0, length(x), 3)
	r <- c()
	for (i in 1:length(lines)) {
		mat[i,1] <- as.numeric(strsplit(x[[i]][2], "\"")[[1]][1])
		mat[i,2] <- as.numeric(strsplit(y[[i]][2], "\"")[[1]][1])
		mat[i,3] <- as.numeric(strsplit(z[[i]][2], "\"")[[1]][1])
		r <- c(r, strsplit(name[[i]][2], "\"")[[1]][1])
	}
	rownames(mat) <- r 
	colnames(mat) <- c("x","y","z")
	return(mat)
}
```



```{r}
# read in pp file as data frame
test_pp <- as.data.frame(read_pp("data/Humerus_picked_points-take2.pp"))
nrow(test_pp)

# take a look, just at the points
library(rgl)
with(test_pp, plot3d(x, y, z, type = 's', size = 0.1))
with(test_pp ,text3d(x,y,z,row.names(test_pp)))
     
# take a look with the bone
library(geomorph)
hum <- read.ply("data/Humerus.ply")
shade3d(hum, color = "gray80")
with(test_pp, plot3d(x, y, z, type = 's', col = "red", add = T))
with(test_pp ,text3d(x,y,z,row.names(test_pp), add = T, cex =2, adj = c(1,1)))
```


## Landmark analysis 

```{r cars}
library(geomorph)
library(rgl)
library(tidyverse)

# put in the specimen ID and the filename
specimen_name <- "modern_human"
file_name <- "Humerus.ply"

# read in PLY file, convert STL to PLY (not binary) with MeshLab
hum <- read.ply(str_glue("data/{file_name}"))

# place points
number_of_landmarks <- 3
hum_points <- digit.fixed(hum, fixed = number_of_landmarks)
# right-click to place, check console and 'y'-enter to confirm

# output points to CSV file to use later, one file per model
write.csv(hum_points, str_glue("{specimen_name}.csv"))
```


## Geometric morphometry


## Hypothesis testing

