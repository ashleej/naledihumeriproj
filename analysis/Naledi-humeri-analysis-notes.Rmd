---
title: "Notes on H. Naledi Analysis: Get the data"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE,
               warning = FALSE,
               message = FALSE)

library(tidyverse)
library(here)
```

## MeshLab worklflow

1. Open model
2. Click ‘pick points’ button
3. Right-click to add points, click ‘not editing’ button to rotate and move model
4. In the pick points ‘form’ window, click Save to save points into a pp file (XML)

## Getting data from Google Drive

Our data are stored on Google Drive. We can access it for analysis using R

```{r eval = FALSE}
library(googledrive)

# here is the ID of our g-drive data folder
data_folder_on_googl_drv_url <- "1IipPeG0bQF92DttpSiCZyiv1H_95UENP"

# get the IDs for each pp file on g-drive
data_files_on_googl_drv <- 
  drive_ls(as_id(data_folder_on_googl_drv_url))

# download all pp files from our g-drive data folder
map(data_files_on_googl_drv$id, 
  ~drive_download(.x, 
                 #path = here("data", "raw_data"),
                 overwrite = TRUE))

# download them to our local folder
pwalk(data_files_on_googl_drv,
    ~drive_download(as_id(..2), # refer to column 2 for the ID
                    # refer to column 1 for the name
                    path = here("data", "raw-data", ..1), 
                    overwrite = TRUE))
```


## Importing Meshlab data into R

Here's the function for reading in pp files

```{r}
# https://rgriff23.github.io/2017/05/07/read-meshlab-pickedpoints.html
# function to read Meshlab *.pp files into R
read.pp <- function (file) {
	file <- readLines(file)
	lines <- file[grep("point", file)]
	x <- strsplit(lines, "x=\"")
	y <- strsplit(lines, "y=\"")
	z <- strsplit(lines, "z=\"")
	name <- strsplit(lines, "name=\"")
	mat <- matrix(0, length(x), 3)
	r <- c()
	for (i in 1:length(lines)) {
		mat[i,1] <- as.numeric(strsplit(x[[i]][2], "\"")[[1]][1])
		mat[i,2] <- as.numeric(strsplit(y[[i]][2], "\"")[[1]][1])
		mat[i,3] <- as.numeric(strsplit(z[[i]][2], "\"")[[1]][1])
		r <- c(r, strsplit(name[[i]][2], "\"")[[1]][1])
	}
	
  df <- as_tibble(mat, .name_repair = make.names )
	df[ ,ncol(df) + 1] <- r 
	colnames(df) <- c( "x","y","z","landmark")
	df <- df[ , c(ncol(df), 1:ncol(df)-1) ]
	return(df)
}
```

Here we read in all the pp files that we downloaded from g-drive 


```{r}
# get list of the local data files
local_data_files <- 
  list.files(path = here("data", "raw-data"),
             pattern = ".pp$",
             full.names = TRUE)

# read these into R, and assign names to each data frame
nsted_df_of_pp_data <- 
  map(local_data_files, 
      read.pp) %>% 
  set_names(basename(local_data_files)) %>% 
  bind_rows(.id = 'specimen') %>% 
  nest(-specimen)

# write an object we can reuse
saveRDS(nsted_df_of_pp_data, 
        here("data", "derived-data", 'nested_df_of_pp_data.rds'))

```

Take a quick look at one specimen:


```{r}
library(plotly)
nsted_df_of_pp_data %>% 
  filter(specimen == 'austro_afarensis_al-137-48a_21-landmarks.pp') %>% 
  unnest() %>% 
  plot_ly(.,
         x = ~x, 
         y = ~y, 
         z = ~z, 
         color = ~landmark) %>%
  add_markers() 
```

One point is out of place here, we may need to exclude it. 




<!--

Let's take a look to see if there are any outliers


df_of_pp_data <- 
nsted_df_of_pp_data %>% 
  unnest()


 plot_ly(df_of_pp_data,
         x = ~x, 
         y = ~y, 
         z = ~z, 
         color = ~specimen) %>%
  add_markers() 
 
 
with(df_of_pp_data,
     plot3d(x, y, z, type = 's', size = 1))
rglwidget()






Let's just look at the H. sapiens


# subset from the full data
h_sapiens <- 
  nsted_df_of_pp_data %>% 
  filter(str_detect(specimen, 
                    "sapiens"))

# take a look, just at the points
library(rgl)

# here is one specimen:
homo_sapiens_01_21_landmarks <- 
h_sapiens %>% 
  slice(1) %>% 
  unnest() 

with(homo_sapiens_01_21_landmarks,
     plot3d(x, y, z, type = 's', size = 1))
rglwidget()
Looks fine. Let's check them all at once to see if all are ok:

# here are many
homo_sapiens_landmarks <- 
h_sapiens %>% 
  unnest() 

with(homo_sapiens_landmarks,
     plot3d(x, y, z, type = 's', size = 1))
rglwidget()


Looks like we have a problem with some values having a very different x-y-z values, compard to the others. Let's take a look at the table, and compute the mean values to get a sense of the ball park for each dimension:


homo_sapiens_landmarks %>% 
  group_by(specimen) %>% 
  summarise_all(mean)


We can see here  that `homo_sapiens_01_21-landmarks.pp` is the problem, so let's drop it, and take another look.     


homo_sapiens_landmarks <- 
  homo_sapiens_landmarks %>% 
  filter(specimen != 'homo_sapiens_01_21-landmarks.pp')

with(homo_sapiens_landmarks,
     plot3d(x, y, z, type = 's', size = 1))
rglwidget()

We need to 


***




test_pp <- as.data.frame(read_pp("data/Humerus_picked_points-take2.pp"))
nrow(test_pp)

# take a look, just at the points
library(rgl)
with(test_pp, plot3d(x, y, z, type = 's', size = 0.1))
with(test_pp ,text3d(x,y,z,row.names(test_pp)))
     
# take a look with the bone
library(geomorph)
hum <- read.ply("data/Humerus.ply")
shade3d(hum, color = "gray80")
with(test_pp, plot3d(x, y, z, type = 's', col = "red", add = T))
with(test_pp ,text3d(x,y,z,row.names(test_pp), add = T, cex =2, adj = c(1,1)))


 


library(geomorph)
library(rgl)
library(tidyverse)

# put in the specimen ID and the filename
specimen_name <- "modern_human"
file_name <- "Humerus.ply"

# read in PLY file, convert STL to PLY (not binary) with MeshLab
hum <- read.ply(str_glue("data/{file_name}"))

# place points
number_of_landmarks <- 3
hum_points <- digit.fixed(hum, fixed = number_of_landmarks)
# right-click to place, check console and 'y'-enter to confirm

# output points to CSV file to use later, one file per model
write.csv(hum_points, str_glue("{specimen_name}.csv"))

-->

## Landmark analysis


## Geometric morphometry


## Hypothesis testing

